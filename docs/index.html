<!DOCTYPE html>
<html lang="fr">
<head>
    <title>Opera Venetia (DH Visualization)</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Bibliothèques externes -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #d62828;       /* Rouge */
            --secondary: #219ebc;     /* Bleu */
            --bg-panel: #ffffff;
            --bg-map: #e5e5e5;
            --text: #333;
            --border: #e9ecef;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Lato', sans-serif;
            color: var(--text);
            background: var(--bg-panel);
            display: grid;
            height: 100vh; width: 100vw;
            /* Grille : Sidebar gauche, Carte en haut droite, Timeline en bas droite */
            grid-template-columns: 340px 1fr;
            grid-template-rows: 1fr 150px;
            grid-template-areas: "sidebar map" "sidebar timeline";
            overflow: hidden;
        }

        /* --- SIDEBAR --- */
        #sidebar {
            grid-area: sidebar;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex; flex-direction: column;
            z-index: 2000;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
        }

        .header-box { padding: 20px; border-bottom: 1px solid var(--border); }
        .title { font-family: 'Playfair Display'; font-size: 22px; margin: 0; color: var(--primary); }
        
        /* Burger & Switch */
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-top: 15px; }
        .burger-btn { background: none; border: none; font-size: 18px; cursor: pointer; color: #666; }
        
        .mode-switch { display: flex; align-items: center; font-size: 0.9em; font-weight: bold; gap: 10px; }
        .switch { position: relative; display: inline-block; width: 36px; height: 20px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider-round { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider-round:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider-round { background-color: var(--secondary); }
        input:checked + .slider-round:before { transform: translateX(16px); }

        /* Onglets */
        .tabs-container { display: none; border-bottom: 1px solid var(--border); background: #f9f9f9; }
        body.compare-mode .tabs-container { display: flex; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-weight: bold; font-size: 0.85em; opacity: 0.6; border-bottom: 3px solid transparent; }
        .tab.active { opacity: 1; border-bottom-color: currentColor; background: #fff; }
        .tab-a.active { color: var(--primary); border-color: var(--primary); }
        .tab-b.active { color: var(--secondary); border-color: var(--secondary); }

        /* Filtres */
        .filters-area { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .search-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 15px; }
        
        .facet-group { margin-bottom: 20px; }
        .facet-title { font-size: 0.75em; font-weight: bold; text-transform: uppercase; color: #888; margin-bottom: 8px; letter-spacing: 1px; }
        .checkbox-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; cursor: pointer; font-size: 0.9em; }
        .checkbox-row:hover { color: var(--primary); }
        .badge { background: #f0f0f0; padding: 2px 6px; border-radius: 10px; font-size: 0.75em; color: #666; }

        /* --- MAP --- */
        #map { grid-area: map; background: var(--bg-map); z-index: 1; }
        /* Gestion des points SVG */
        .leaflet-interactive { mix-blend-mode: multiply; transition: r 0.5s ease-out, fill-opacity 0.3s; }

        /* --- TIMELINE --- */
        #timeline-panel {
            grid-area: timeline;
            background: var(--bg-panel);
            border-top: 1px solid var(--border);
            padding: 10px 40px;
            display: flex; flex-direction: column;
            z-index: 1000;
        }

        .controls { display: flex; align-items: center; margin-bottom: 5px; }
        .play-btn {
            width: 32px; height: 32px; border-radius: 50%; border: 2px solid var(--primary);
            background: none; color: var(--primary); cursor: pointer; margin-right: 15px;
            display: flex; justify-content: center; align-items: center;
        }
        .play-btn:hover { background: var(--primary); color: white; }
        .date-display { font-family: 'Playfair Display'; font-size: 1.2em; font-weight: bold; margin-right: 20px; }
        .legend { display: flex; gap: 15px; font-size: 0.85em; font-weight: bold; }

        /* Histogramme */
        #histogram { flex-grow: 1; width: 100%; display: flex; align-items: flex-end; margin-bottom: 5px; }
        .hist-col { flex: 1; height: 100%; margin: 0 1px; position: relative; display: flex; flex-direction: column-reverse; }
        .bar-bg { position: absolute; bottom: 0; width: 100%; background: #e0e0e0; z-index: 0; transition: height 0.3s; }
        .bar-a { width: 100%; background: var(--primary); opacity: 0.6; z-index: 2; transition: height 0.3s; }
        .bar-b { width: 100%; background: var(--secondary); opacity: 0.6; z-index: 1; transition: height 0.3s; display: none; }
        body.compare-mode .bar-b { display: block; }

        /* Slider */
        #time-slider { height: 6px; border: none; background: transparent; }
        .noUi-connect { background: #888; opacity: 0.3; }
        .noUi-handle { width: 14px; height: 14px; border-radius: 50%; background: #555; border: 2px solid #fff; top: -4px; right: -7px; cursor: grab; box-shadow: none; }

        /* Menu Overlay */
        #menu-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:5000; display:none; justify-content:center; align-items:center; }
        #menu-box { background:white; padding:30px; border-radius:8px; width:400px; max-width:90%; }
        
        /* Error Message */
        #error-banner {
            position: absolute; top: 20px; left: 50%; transform: translateX(-50%);
            background: #d62828; color: white; padding: 15px 30px; border-radius: 8px;
            z-index: 9999; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.3); text-align: center;
        }
    </style>
</head>
<body>

    <!-- Message d'erreur si les données ne chargent pas -->
    <div id="error-banner">
        <strong>Erreur de chargement : sample_operas.geojson</strong><br>
        <small>Vérifiez que le fichier est dans le même dossier et que vous utilisez un serveur local (pas file://).</small>
    </div>

    <!-- SIDEBAR -->
    <div id="sidebar">
        <div class="header-box">
            <h1 class="title">Opera Venetia</h1>
            <div class="header-controls">
                <div class="mode-switch">
                    <span>Comparer (A/B)</span>
                    <label class="switch">
                        <input type="checkbox" id="modeToggle" onchange="toggleMode()">
                        <span class="slider-round"></span>
                    </label>
                </div>
                <button class="burger-btn" onclick="toggleMenu()"><i class="fas fa-bars"></i></button>
            </div>
        </div>

        <div class="tabs-container">
            <div class="tab tab-a active" onclick="switchTab('A')">Recherche A</div>
            <div class="tab tab-b" onclick="switchTab('B')">Recherche B</div>
        </div>

        <div class="filters-area">
            <input type="text" id="searchInput" class="search-input" placeholder="Rechercher (Titre, Théâtre)..." onkeyup="handleSearch()">
            <div id="facets-container">Chargement des filtres...</div>
        </div>
    </div>

    <!-- MAP -->
    <div id="map"></div>

    <!-- TIMELINE -->
    <div id="timeline-panel">
        <div class="controls">
            <button class="play-btn" onclick="togglePlay()"><i id="play-icon" class="fas fa-play"></i></button>
            <div class="date-display" id="date-display">1660 - 1760</div>
            <div class="legend">
                <span style="color:var(--primary)"><i class="fas fa-circle"></i> <span id="count-a">0</span></span>
                <span id="legend-b" style="color:var(--secondary); display:none;"><i class="fas fa-circle"></i> <span id="count-b">0</span></span>
            </div>
        </div>
        <div id="histogram"></div>
        <div id="time-slider"></div>
    </div>

    <!-- MENU -->
    <div id="menu-overlay" onclick="if(event.target==this) toggleMenu()">
        <div id="menu-box">
            <h2 style="margin-top:0; font-family:'Playfair Display'">Paramètres</h2>
            <div style="margin:15px 0; display:flex; justify-content:space-between;">
                <span>Fond de carte</span>
                <select id="mapStyle" onchange="changeMapStyle(this.value)">
                    <option value="voyager">Clair (Voyager)</option>
                    <option value="dark_all">Sombre</option>
                    <option value="light_all">Minimaliste</option>
                </select>
            </div>
            <hr>
            <p><strong>Crédits</strong><br>Développeur DH<br>Données : sample_operas.geojson</p>
            <button onclick="toggleMenu()" style="width:100%; padding:10px; cursor:pointer;">Fermer</button>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.0/nouislider.min.js"></script>

    <script>
        // --- CONFIG ---
        const CONFIG = { min: 1660, max: 1760 };
        let state = {
            mode: 'simple',
            activeTab: 'A',
            queries: { A: { filters: {}, search: "" }, B: { filters: {}, search: "" } },
            range: [1660, 1760],
            data: [],
            results: { A: [], B: [] },
            isPlaying: false
        };

        let map, layerA, layerB, tileLayer, slider, playInterval;

        // --- INITIALISATION ---
        document.addEventListener("DOMContentLoaded", () => {
            
            // 1. Setup Map
            map = L.map('map', { zoomControl: false }).setView([45.437, 12.335], 14);
            L.control.zoom({ position: 'topright' }).addTo(map);
            changeMapStyle('voyager');

            layerA = L.layerGroup().addTo(map);
            layerB = L.layerGroup().addTo(map);

            // 2. Charger les données
            fetch('sample_operas.geojson')
                .then(response => {
                    if (!response.ok) throw new Error("HTTP error " + response.status);
                    return response.json();
                })
                .then(data => {
                    if (data.features) {
                        state.data = data.features;
                        console.log("Données chargées : ", state.data.length + " opéras.");
                        initApp();
                    } else {
                        throw new Error("Format GeoJSON incorrect (pas de features).");
                    }
                })
                .catch(err => {
                    console.error(err);
                    document.getElementById('error-banner').style.display = 'block';
                    document.getElementById('error-banner').innerHTML += `<br>Détail: ${err.message}`;
                });
        });

        function initApp() {
            // Slider UI
            slider = noUiSlider.create(document.getElementById('time-slider'), {
                start: [CONFIG.min, CONFIG.max],
                connect: true,
                range: { 'min': CONFIG.min, 'max': CONFIG.max },
                step: 1,
                animate: false
            });
            slider.on('update', (v) => {
                state.range = [Math.round(v[0]), Math.round(v[1])];
                document.getElementById('date-display').innerText = `${state.range[0]} - ${state.range[1]}`;
                updateAll();
            });

            // Histogramme DOM
            const histContainer = document.getElementById('histogram');
            for(let y = CONFIG.min; y <= CONFIG.max; y++) {
                let col = document.createElement('div');
                col.className = 'hist-col';
                col.id = 'h-' + y;
                col.innerHTML = `<div class="bar-bg"></div><div class="bar-a"></div><div class="bar-b"></div>`;
                histContainer.appendChild(col);
            }

            // UI Facettes
            renderFacets();
            
            // Premier Rendu
            updateAll();
        }

        // --- LOGIQUE ---

        function toggleMode() {
            state.mode = document.getElementById('modeToggle').checked ? 'compare' : 'simple';
            document.body.classList.toggle('compare-mode', state.mode === 'compare');
            document.getElementById('legend-b').style.display = state.mode === 'compare' ? 'inline' : 'none';
            
            if (state.mode === 'simple') switchTab('A');
            updateAll();
        }

        function switchTab(tab) {
            state.activeTab = tab;
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            document.querySelector('.tab-' + tab.toLowerCase()).classList.add('active');
            
            // Restaurer l'état de l'input recherche
            document.getElementById('searchInput').value = state.queries[tab].search;
            renderFacets();
        }

        function updateAll() {
            // 1. Filtrage
            state.results.A = filterData(state.queries.A);
            state.results.B = state.mode === 'compare' ? filterData(state.queries.B) : [];

            // 2. Carte
            drawMap();

            // 3. Histogramme
            drawHistogram();

            // 4. Compteurs
            document.getElementById('count-a').innerText = state.results.A.length;
            document.getElementById('count-b').innerText = state.results.B.length;
        }

        function filterData(query) {
            const [start, end] = state.range;
            return state.data.filter(f => {
                const p = f.properties;
                // Filtre temps
                if (p.annee < start || p.annee > end) return false;
                // Filtre recherche
                if (query.search) {
                    const fullText = (p.titre + " " + p.theatre + " " + p.compositeur).toLowerCase();
                    if (!fullText.includes(query.search)) return false;
                }
                // Filtre facettes
                for (let key in query.filters) {
                    if (query.filters[key].size > 0 && !query.filters[key].has(p[key])) return false;
                }
                return true;
            });
        }

        // --- VISUALISATION ---

        function drawMap() {
            layerA.clearLayers();
            layerB.clearLayers();

            const renderLayer = (dataset, layer, color) => {
                // Agrégation spatiale
                let venues = {};
                dataset.forEach(f => {
                    let t = f.properties.theatre;
                    if (!venues[t]) venues[t] = { ...f.geometry, count: 0, list: [] };
                    venues[t].count++;
                    venues[t].list.push(f.properties.titre);
                });

                // Dessin des points
                for (let key in venues) {
                    let v = venues[key];
                    // GeoJSON est [Lng, Lat], Leaflet veut [Lat, Lng]
                    let latlng = [v.coordinates[1], v.coordinates[0]]; 
                    let r = Math.sqrt(v.count) * 5 + 3;
                    
                    L.circleMarker(latlng, {
                        radius: r, color: color, fillColor: color, fillOpacity: 0.6, weight: 1
                    })
                    .bindPopup(`<b>${key}</b><br>${v.count} opéras<br><small>${v.list.slice(0,3).join(', ')}...</small>`)
                    .addTo(layer);
                }
            };

            if (state.results.A.length) renderLayer(state.results.A, layerA, '#d62828');
            if (state.results.B.length) renderLayer(state.results.B, layerB, '#219ebc');
        }

        function drawHistogram() {
            // Stats globales pour l'échelle (Background)
            let globalCounts = {}, maxVal = 0;
            state.data.forEach(f => {
                globalCounts[f.properties.annee] = (globalCounts[f.properties.annee] || 0) + 1;
                if (globalCounts[f.properties.annee] > maxVal) maxVal = globalCounts[f.properties.annee];
            });

            // Stats filtrées (sans restriction temporelle pour voir la distribution)
            const getDistribution = (query) => {
                let counts = {};
                state.data.filter(f => {
                    // Appliquer Search et Facettes, mais PAS l'année
                    if (query.search && !(f.properties.titre + "").toLowerCase().includes(query.search)) return false;
                    for (let k in query.filters) {
                        if (query.filters[k].size > 0 && !query.filters[k].has(f.properties[k])) return false;
                    }
                    return true;
                }).forEach(f => counts[f.properties.annee] = (counts[f.properties.annee] || 0) + 1);
                return counts;
            };

            let countsA = getDistribution(state.queries.A);
            let countsB = state.mode === 'compare' ? getDistribution(state.queries.B) : {};

            for (let y = CONFIG.min; y <= CONFIG.max; y++) {
                let col = document.getElementById('h-' + y);
                let hBg = maxVal ? (globalCounts[y] || 0) / maxVal * 100 : 0;
                let hA = maxVal ? (countsA[y] || 0) / maxVal * 100 : 0;
                let hB = maxVal ? (countsB[y] || 0) / maxVal * 100 : 0;

                col.querySelector('.bar-bg').style.height = hBg + '%';
                col.querySelector('.bar-a').style.height = hA + '%';
                col.querySelector('.bar-b').style.height = hB + '%';

                // Opacité hors plage
                let inRange = (y >= state.range[0] && y <= state.range[1]);
                col.style.opacity = inRange ? 1 : 0.3;
            }
        }

        // --- UI HELPERS ---

        function renderFacets() {
            const container = document.getElementById('facets-container');
            container.innerHTML = '';
            const query = state.queries[state.activeTab];

            ['theatre', 'compositeur', 'librettiste'].forEach(cat => {
                // Compter les occurrences
                let counts = {};
                state.data.forEach(f => {
                    if (f.properties[cat]) counts[f.properties[cat]] = (counts[f.properties[cat]] || 0) + 1;
                });

                let group = document.createElement('div');
                group.className = 'facet-group';
                group.innerHTML = `<div class="facet-title">${cat}</div>`;

                Object.keys(counts).sort().forEach(val => {
                    let isChecked = query.filters[cat] && query.filters[cat].has(val);
                    let row = document.createElement('div');
                    row.className = 'checkbox-row';
                    row.innerHTML = `
                        <label style="display:flex; align-items:center; width:100%; cursor:pointer;">
                            <input type="checkbox" ${isChecked ? 'checked' : ''} style="margin-right:8px"> ${val}
                        </label>
                        <span class="badge">${counts[val]}</span>
                    `;
                    row.querySelector('input').onchange = (e) => {
                        if (!query.filters[cat]) query.filters[cat] = new Set();
                        e.target.checked ? query.filters[cat].add(val) : query.filters[cat].delete(val);
                        updateAll();
                    };
                    group.appendChild(row);
                });
                container.appendChild(group);
            });
        }

        function handleSearch() {
            state.queries[state.activeTab].search = document.getElementById('searchInput').value.toLowerCase();
            updateAll();
        }

        function toggleMenu() {
            let el = document.getElementById('menu-overlay');
            el.style.display = (el.style.display === 'flex') ? 'none' : 'flex';
        }

        function changeMapStyle(style) {
            if (tileLayer) map.removeLayer(tileLayer);
            tileLayer = L.tileLayer(`https://{s}.basemaps.cartocdn.com/rastertiles/${style}/{z}/{x}/{y}{r}.png`, {
                attribution: '&copy; CARTO'
            }).addTo(map);
            layerA.bringToFront(); layerB.bringToFront();
        }

        function togglePlay() {
            state.isPlaying = !state.isPlaying;
            let icon = document.getElementById('play-icon');
            icon.className = state.isPlaying ? "fas fa-pause" : "fas fa-play";

            if (state.isPlaying) {
                let span = state.range[1] - state.range[0];
                let cursor = state.range[0];
                playInterval = setInterval(() => {
                    cursor++;
                    if (cursor + span > CONFIG.max) return togglePlay();
                    slider.set([cursor, cursor + span]);
                }, 800);
            } else {
                clearInterval(playInterval);
            }
        }
    </script>
</body>
</html>